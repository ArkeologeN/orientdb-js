/*! orientdb-js 2013-07-20 */
!function(){"use strict";function a(a){return!!this.OPTS.idRegex&&b(a)&&this.OPTS.idRegex.test(a)}function b(a){return"[object String]"===p.call(a)}function c(a){return b(a)&&q.test(a)}function d(a){return"[object Object]"===p.call(a)}function e(a){return b(a)&&r.test(a)}function f(a){return"[object Array]"===p.call(a)}function g(a,b,c){return function(){var d,e=this,g=f(arguments[0])?arguments[0]:arguments,i="";if(d=c?new s(b):e._buildREST(e.params),"idx"==a&&g.length>1){for(var j in g[1])i=j+":",i+=h.call(e,g[1][j]);i="[["+i+"]]",g.length=1}return d.params+="."+a+m.call(e,g),d.params+=i,d}}function h(b){return d(b)&&b.hasOwnProperty("params")&&c(b.params)?b.params.toString():c(b)?b.toString():a.call(this,b)||isNaN(parseFloat(b))?"'"+b+"'":isNaN(parseFloat(b))?b:b.toString()}function i(){return function(a){var b=this._buildREST(this.params);return b.params+="["+a.toString()+"]",b}}function j(a){return function(){var b=this,c=b._buildREST(b.params),d=d(arguments[0]),e=d?arguments[0].length:arguments.length;c.params+="."+a+"(";for(var f=0;e>f;f++)c.params+=d?arguments[0][f].params||h.call(b,arguments[0][f]):arguments[f].params||h.call(b,arguments[f]),c.params+=",";return c.params=c.params.slice(0,-1),c.params+=")",c}}function k(a){return function(){var b=this._buildREST(this.params);b.params+="."+a+"([";for(var c=0,d=arguments[0].length;d>c;c++)b.params+=arguments[0][c].params,b.params+=",";return b.params=b.params.slice(0,-1),b.params+="])",b}}function l(a){return function(){var b,c=arguments[0];return b=new s(a,"/sql"),b.params=c,b}}function m(a){for(var b="",f="",g="",i=0,j=a.length;j>i;i++)e(a[i])?f+=a[i]:!d(a[i])||a[i].hasOwnProperty("params")&&c(a[i].params)?b+=h.call(this,a[i])+",":(g=JSON.stringify(a[i]),g=g.replace("{","["),b+=g.replace("}","]")+",");return b=b.slice(0,-1),"("+b+")"+f}var n=require("q"),o=require("http"),p=Object.prototype.toString;Array.prototype.push;var q=/^T\.(gt|gte|eq|neq|lte|lt)$|^g\.|^Vertex(?=\.class\b)|^Edge(?=\.class\b)/,r=/^\{.*\}$/,s=function(){function a(a,b){this.pathBase="/command/",this.urlPath=b||"/gremlin",this.OPTS=a,this.params="g"}function b(a,b){var c=a+":"+b,d=new Buffer(c).toString("base64");return"Basic "+d}function c(){return function(a,c){var e=this.pathBase+this.OPTS.graph,f=this.params,g=b(this.OPTS.user,this.OPTS.password),h={Authorization:g};return d.call(this,e+this.urlPath,f,h).then(a,c)}}function d(a,b,c){var d=n.defer(),e=b||"{}",f="",g={host:this.OPTS.host,port:this.OPTS.port,path:a,headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(e,"utf8")},method:"POST"};for(var h in c)c.hasOwnProperty(h)&&(g.headers[h]=c[h]);var i=o.request(g,function(a){a.on("data",function(a){f+=a}),a.on("end",function(){d.resolve(JSON.parse(f))})});return i.on("error",function(a){console.error("problem with request: "+a.message),d.reject("Error: "+a.message)}),i.write(e),i.end(),d.promise}return a.prototype={_buildREST:function(a){return this.params=a,this},both:g("both"),bothE:g("bothE"),bothV:g("bothV"),cap:g("cap"),gather:g("gather"),id:g("id"),"in":g("in"),inE:g("inE"),inV:g("inV"),property:g("property"),label:g("label"),map:g("map"),memoize:g("memoize"),order:g("order"),out:g("out"),outE:g("outE"),outV:g("outV"),path:g("path"),scatter:g("scatter"),select:g("select"),transform:g("transform"),index:i(),range:i(),and:j("and"),back:g("back"),dedup:g("dedup"),except:k("except"),filter:g("filter"),has:g("has"),hasNot:g("hasNot"),interval:g("interval"),or:j("or"),random:g("random"),retain:k("retain"),simplePath:g("simplePath"),as:g("as"),groupBy:g("groupBy"),groupCount:g("groupCount"),optional:g("optional"),sideEffect:g("sideEffect"),linkBoth:g("linkBoth"),linkIn:g("linkIn"),linkOut:g("linkOut"),copySplit:j("copySplit"),exhaustMerge:g("exhaustMerge"),fairMerge:g("fairMerge"),ifThenElse:g("ifThenElse"),loop:g("loop"),count:g("count"),iterate:g("iterate"),next:g("next"),toList:g("toList"),put:j("put"),getPropertyKeys:g("getPropertyKeys"),setProperty:g("setProperty"),getProperty:g("getProperty"),then:c()},a}(),t=function(){function a(a){this.OPTS={host:"localhost",port:2480,graph:"tinkergraph",idRegex:/^[0-9]+:[0-9]+$/},a&&this.setOptions(a),this.V=g("V",this.OPTS,!0),this._=g("_",this.OPTS,!0),this.E=g("E",this.OPTS,!0),this.V=g("V",this.OPTS,!0),this.sql=l(this.OPTS),this.e=g("e",this.OPTS,!0),this.idx=g("idx",this.OPTS,!0),this.v=g("v",this.OPTS,!0),this.createIndex=g("createIndex"),this.createKeyIndex=g("createKeyIndex"),this.getIndices=g("getIndices"),this.getIndexedKeys=g("getIndexedKeys"),this.getIndex=g("getIndex"),this.dropIndex=g("dropIndex"),this.dropKeyIndex=g("dropKeyIndex"),this.clear=g("clear"),this.shutdown=g("shutdown"),this.getFeatures=g("getFeatures")}return a.prototype.setOptions=function(a){if(a)for(var b in a)a.hasOwnProperty(b)&&(this.OPTS[b]=a[b])},a.prototype.setAuth=function(a,b){this.setOptions({user:a,password:b})},a.prototype.begin=function(){return new Trxn(this.OPTS)},a}();module.exports=t}();